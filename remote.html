<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Teleprompter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background: #111;
  color: white;
  font-family: Arial, sans-serif;
  padding: 15px;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

header {
  display: flex;
  justify-content: flex-end;
}

header img {
  max-width: 160px;
  width: 50%;
}

#content {
  flex: 1;
}

textarea, input, progress {
  width: 100%;
  margin-bottom: 10px;
}

button {
  width: 100%;
  padding: 14px;
  margin-bottom: 8px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
}

.green { background: #1abc9c; }
.orange { background: #f39c12; }
.purple { background: #9b59b6; }

footer {
  text-align: center;
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
}

/* Presentador */
#presenter {
  background: #1a1a1a;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.small {
  font-size: 14px;
  color: #ccc;
}
</style>
</head>

<body>

<header>
  <img src="logo-escuela.svg">
</header>

<div id="content">

<input type="password" id="pin" value="1234">

<div id="presenter">
  <div><strong>üìç Actual</strong></div>
  <div id="current" class="small">---</div>

  <div style="margin-top:6px;"><strong>‚è≠ Siguiente</strong></div>
  <div id="next" class="small">---</div>

  <div style="margin-top:6px;">
    ‚è± Tiempo restante: <span id="time">--</span><br>
    üéö Velocidad: <span id="spd">0</span>
  </div>

  <progress id="progress" value="0" max="100"></progress>
</div>

<input type="file" accept=".txt,.md,.docx" onchange="loadFile(event)">
<textarea id="script" rows="5"></textarea>

<button class="green" onclick="sendText()">üì§ Enviar texto</button>
<button class="orange" onclick="toggleCamera()">üé• Modo C√°mara</button>
<button class="purple" onclick="changeSpeed(0.5)">‚ûï Velocidad</button>
<button class="purple" onclick="changeSpeed(-0.5)">‚ûñ Velocidad</button>

</div>

<footer>
Creaciones Manotas
</footer>

<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
const socket = new WebSocket("wss://teleprompter-ws-5ziy.onrender.com");
let speed = 0;
let fullText = "";

socket.onmessage = e => {
  const data = JSON.parse(e.data);
  if (data.action !== "status") return;
  if (data.pin !== document.getElementById("pin").value) return;

  const progress = Math.min(100, (data.y / data.total) * 100);
  document.getElementById("progress").value = progress;
  document.getElementById("spd").innerText = data.speed;

  const remaining = (data.total - data.y) / (data.speed * 30 || 1);
  document.getElementById("time").innerText =
    Math.max(0, Math.round(remaining)) + " s";

  updateBlocks(progress);
};

function updateBlocks(progress) {
  const parts = fullText.split("\n\n");
  const index = Math.floor((progress / 100) * parts.length);
  document.getElementById("current").innerText = parts[index] || "";
  document.getElementById("next").innerText = parts[index + 1] || "";
}

function send(action, value = null) {
  socket.send(JSON.stringify({
    action,
    value,
    pin: document.getElementById("pin").value
  }));
}

function sendText() {
  fullText = document.getElementById("script").value;
  send("text", fullText);
}

function toggleCamera() {
  send("camera");
}

function changeSpeed(delta) {
  speed = Math.max(0, speed + delta);
  send("speed", speed);
}

function loadFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const ext = file.name.split(".").pop().toLowerCase();

  const reader = new FileReader();
  reader.onload = ev => {
    if (ext === "docx") {
      mammoth.extractRawText({ arrayBuffer: ev.target.result })
        .then(res => document.getElementById("script").value = res.value);
    } else {
      document.getElementById("script").value = ev.target.result;
    }
  };

  ext === "docx" ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
}
</script>

</body>
</html>

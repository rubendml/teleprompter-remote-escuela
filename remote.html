<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Teleprompter Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root {
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#22c55e;
  --warn:#f59e0b;
  --info:#8b5cf6;
  --brand:#ffd700;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}
header{
  display:flex;
  justify-content:flex-end;
  padding:12px 16px;
}
header img{max-width:140px}
main{
  flex:1;
  padding:16px;
  display:grid;
  gap:14px;
}
.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:0 10px 20px rgba(0,0,0,.25);
}
.card h3{
  margin:0 0 10px;
  font-size:14px;
  color:var(--muted);
}
textarea,input{
  width:100%;
  background:#020617;
  color:var(--text);
  border:1px solid #334155;
  border-radius:10px;
  padding:10px;
  font-size:15px;
}
textarea{min-height:90px}
.buttons{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
button{
  border:none;
  border-radius:12px;
  padding:14px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
.send{background:var(--accent);color:#022c22}
.camera{background:var(--warn);color:#3a2500}
.plus{background:var(--info)}
.minus{background:#475569}
.presenter small{color:var(--muted);display:block}
.presenter progress{width:100%;height:10px;margin-top:8px}
.pin-box{margin:0 16px 8px}
.pin-box small{color:var(--muted);display:block;margin-bottom:4px}
footer{
  text-align:center;
  padding:10px;
  font-size:17px;
  font-weight:bold;
  color:var(--brand);
}
#installBtn{
  margin:8px auto 0;
  display:block;
  background:transparent;
  color:#94a3b8;
  border:1px dashed #475569;
  border-radius:10px;
  padding:8px 14px;
  font-size:14px;
  cursor:pointer;
}
#installBtn:hover{
  color:#e5e7eb;
  border-color:#e5e7eb;
}
</style>
</head>

<body>

<header>
  <img src="logo-escuela.svg" alt="Logo Escuela Judicial">
</header>

<main>

<div class="card presenter">
  <h3>ğŸ¤ Vista del presentador</h3>
  <small>Actual</small>
  <div id="current">---</div>
  <small style="margin-top:6px">Siguiente</small>
  <div id="next">---</div>
  <small style="margin-top:6px">
    â± <span id="time">--</span> Â· ğŸš <span id="spd">0</span>
  </small>
  <progress id="progress" value="0" max="100"></progress>
</div>

<div class="card">
  <h3>ğŸ“„ Texto</h3>
  <input type="file" accept=".txt,.md,.docx" onchange="loadFile(event)">
  <textarea id="script"></textarea>
</div>

<div class="card buttons">
  <button class="send" onclick="sendText()">ğŸ“¤ Enviar</button>
  <button class="camera" onclick="toggleCamera()">ğŸ¥ CÃ¡mara</button>
  <button class="plus" onclick="changeSpeed(0.5)">â• Vel</button>
  <button class="minus" onclick="changeSpeed(-0.5)">â– Vel</button>
</div>

</main>

<div class="pin-box">
  <small>ğŸ” PIN de control</small>
  <input type="password" id="pin" value="1234">
</div>

<footer>
  Creaciones Manotas - Ver. 2.5.1
  <button id="installBtn" onclick="installApp()">ğŸ“² Instalar aplicaciÃ³n</button>
</footer>

<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
/* ===============================
   INSTALACIÃ“N DIRECTA ANDROID
================================ */
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
});

function installApp(){
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.finally(()=>{
      deferredPrompt = null;
    });
  } else {
    const ua = navigator.userAgent.toLowerCase();
    if(ua.includes("iphone") || ua.includes("ipad")){
      alert(
        "iOS:\n" +
        "1. Pulsa Compartir\n" +
        "2. Agregar a pantalla de inicio"
      );
    } else {
      alert(
        "Usa el menÃº del navegador para instalar la aplicaciÃ³n"
      );
    }
  }
}

/* ===============================
   WEBSOCKET ROBUSTO
================================ */
const WS_URL="wss://teleprompter-ws-5ziy.onrender.com";
let socket, socketReady=false, speed=0, fullText="";

function connectSocket(){
  socket=new WebSocket(WS_URL);
  socket.onopen=()=>socketReady=true;
  socket.onclose=()=>{socketReady=false;setTimeout(connectSocket,2000)};
  socket.onmessage=e=>{
    const d=JSON.parse(e.data);
    if(d.action!=="status"||d.pin!==pin.value)return;
    const p=Math.min(100,(d.y/d.total)*100);
    progress.value=p;
    spd.innerText=d.speed;
    time.innerText=Math.max(0,Math.round((d.total-d.y)/(d.speed*30||1)))+" s";
    updateBlocks(p);
  };
}
connectSocket();

function updateBlocks(p){
  const parts=fullText.split("\n\n");
  const i=Math.floor((p/100)*parts.length);
  current.innerText=parts[i]||"";
  next.innerText=parts[i+1]||"";
}

function send(action,value=null){
  if(!socketReady){alert("Conectandoâ€¦");return;}
  socket.send(JSON.stringify({action,value,pin:pin.value}));
}
function sendText(){fullText=script.value;send("text",fullText);}
function toggleCamera(){send("camera");}
function changeSpeed(d){speed=Math.max(0,speed+d);send("speed",speed);}

function loadFile(e){
  const f=e.target.files[0];if(!f)return;
  const ext=f.name.split(".").pop().toLowerCase();
  const r=new FileReader();
  r.onload=ev=>{
    if(ext==="docx"){
      mammoth.extractRawText({arrayBuffer:ev.target.result})
        .then(res=>script.value=res.value);
    } else script.value=ev.target.result;
  };
  ext==="docx"?r.readAsArrayBuffer(f):r.readAsText(f);
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js",{scope:"./"});
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Teleprompter Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background: #111;
  color: white;
  font-family: Arial, sans-serif;
  padding: 15px;
}

textarea, input[type=file] {
  width: 100%;
  margin-bottom: 10px;
  font-size: 16px;
}

button {
  width: 100%;
  padding: 14px;
  margin-bottom: 8px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
}

.green { background: #1abc9c; }
.blue { background: #3498db; }
.orange { background: #f39c12; }
.purple { background: #9b59b6; }
.red { background: #e74c3c; }

#status {
  text-align: center;
  margin-bottom: 10px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>ğŸ® Control Teleprompter</h2>

<div id="status">ğŸ”„ Conectando al servidorâ€¦</div>

<input type="file" accept=".txt,.md,.docx" onchange="loadFile(event)">

<textarea id="script" rows="8" placeholder="Escribe o pega el texto aquÃ­â€¦"></textarea>

<button class="green" onclick="sendText()">ğŸ“¤ Enviar texto</button>
<button class="blue" onclick="toggleMirror()">ğŸ” Espejo</button>
<button class="orange" onclick="toggleGuide()">ğŸ¯ LÃ­nea guÃ­a</button>

<button class="purple" onclick="changeSpeed(0.5)">â• Velocidad</button>
<button class="purple" onclick="changeSpeed(-0.5)">â– Velocidad</button>

<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
let socket;
let speed = 0;
const statusEl = document.getElementById("status");

function connectSocket() {
  socket = new WebSocket("wss://teleprompter-ws-5ziy.onrender.com");

  socket.onopen = () => {
    statusEl.innerText = "ğŸŸ¢ Conectado al teleprompter";
  };

  socket.onerror = () => {
    statusEl.innerText = "ğŸ”´ Error de conexiÃ³n";
  };

  socket.onclose = () => {
    statusEl.innerText = "âš ï¸ ConexiÃ³n perdida, reconectandoâ€¦";
    setTimeout(connectSocket, 2000);
  };
}

connectSocket();

function send(action, value = null) {
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    statusEl.innerText = "â³ Esperando conexiÃ³nâ€¦";
    return;
  }

  statusEl.innerText = "ğŸ“¤ Enviando informaciÃ³nâ€¦";
  socket.send(JSON.stringify({ action, value }));

  setTimeout(() => {
    statusEl.innerText = "ğŸŸ¢ Enviado correctamente";
  }, 500);
}

function sendText() {
  send("text", document.getElementById("script").value);
}

function toggleMirror() {
  send("mirror");
}

function toggleGuide() {
  send("guide");
}

function changeSpeed(delta) {
  speed = Math.max(0, speed + delta);
  send("speed", speed);
}

/* CARGA DE ARCHIVOS */
function loadFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const ext = file.name.split(".").pop().toLowerCase();

  if (ext === "txt" || ext === "md") {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("script").value = e.target.result;
    };
    reader.readAsText(file);
  }

  if (ext === "docx") {
    const reader = new FileReader();
    reader.onload = e => {
      mammoth.extractRawText({ arrayBuffer: e.target.result })
        .then(result => {
          document.getElementById("script").value = result.value;
        })
        .catch(() => alert("Error leyendo DOCX"));
    };
    reader.readAsArrayBuffer(file);
  }
}
</script>

</body>
</html>

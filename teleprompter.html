<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Teleprompter Pro</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  color: #f5f5f5;
  font-family: Arial, Helvetica, sans-serif;
  overflow: hidden;
}

/* CONTENEDOR */
#container {
  position: relative;
}

/* TEXTO PRINCIPAL */
#text {
  font-size: 64px;
  line-height: 1.5;
  padding: 14vh 12vw;
  white-space: pre-wrap;
  transform-origin: center;
  display: none; /* oculto al inicio */
}

/* ESPEJO */
.mirror {
  transform: scaleX(-1);
}

/* L√çNEA GU√çA */
#guide {
  position: fixed;
  top: 50%;
  left: 0;
  right: 0;
  height: 2px;
  background: rgba(255,255,255,0.25);
  pointer-events: none;
}

/* MODO C√ÅMARA */
.camera #guide {
  display: block;
}

/* BIENVENIDA */
#welcome {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 16px;
  text-align: center;
  padding: 20px;
}

#welcome img {
  max-width: 300px;
  width: 60%;
  height: auto;
}

#welcome a {
  color: #ffd700;
  font-size: 20px;
  text-decoration: none;
}

#welcome p {
  font-size: 26px;
  opacity: 0.85;
}
</style>
</head>

<body>

<div id="container">

  <!-- BIENVENIDA -->
  <div id="welcome">
    <img src="logo-escuela.svg" alt="Logo Escuela Judicial">
    <a href="https://escuelajudicial.ramajudicial.gov.co/" target="_blank">
      escuelajudicial.ramajudicial.gov.co
    </a>
    <p>Esperando texto‚Ä¶</p>
  </div>

  <!-- TEXTO -->
  <div id="text" class="mirror"></div>

  <!-- GU√çA -->
  <div id="guide"></div>

</div>

<script>
/* ===============================
   CONFIGURACI√ìN
================================ */
const WS_URL = "wss://teleprompter-ws-5ziy.onrender.com";
const PIN = "1234";

/* ===============================
   ELEMENTOS
================================ */
const textEl = document.getElementById("text");
const welcomeEl = document.getElementById("welcome");

/* ===============================
   VARIABLES
================================ */
let socket;
let socketReady = false;
let scrollSpeed = 0;
let yPos = 0;
let lastTime = null;
let totalHeight = 0;

/* ===============================
   CONEXI√ìN WEBSOCKET ROBUSTA
================================ */
function connectSocket() {
  socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    socketReady = true;
    console.log("üü¢ WebSocket conectado");
  };

  socket.onclose = () => {
    socketReady = false;
    console.warn("‚ö†Ô∏è WebSocket cerrado. Reintentando‚Ä¶");
    setTimeout(connectSocket, 2000);
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.pin !== PIN) return;

    if (data.action === "text") {
      if (data.value && data.value.trim() !== "") {
        // Mostrar texto
        textEl.innerText = data.value;
        textEl.style.display = "block";
        welcomeEl.style.display = "none";
        yPos = 0;
        window.scrollTo(0, 0);

        setTimeout(() => {
          totalHeight = document.body.scrollHeight;
        }, 100);
      } else {
        // Volver a bienvenida
        textEl.innerText = "";
        textEl.style.display = "none";
        welcomeEl.style.display = "flex";
      }
    }

    if (data.action === "speed") {
      scrollSpeed = Number(data.value) || 0;
    }

    if (data.action === "camera") {
      document.body.classList.toggle("camera");
      textEl.classList.toggle("mirror");
    }
  };
}

connectSocket();

/* ===============================
   SCROLL + ENV√çO DE ESTADO
================================ */
function animate(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const delta = timestamp - lastTime;
  lastTime = timestamp;

  yPos += scrollSpeed * delta * 0.06;
  window.scrollTo(0, yPos);

  if (socketReady && totalHeight > 0) {
    socket.send(JSON.stringify({
      action: "status",
      pin: PIN,
      y: yPos,
      total: totalHeight,
      speed: scrollSpeed
    }));
  }

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
</script>

</body>
</html>
